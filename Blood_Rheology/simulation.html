<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Rheology and Non-Newtonian Behavior</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #34495e;
        }
        
        input[type="range"] {
            width: 100%;
            margin: 10px 0;
            appearance: none;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #d63031;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .value-display {
            font-size: 14px;
            color: #7f8c8d;
            text-align: center;
            margin-top: 5px;
        }
        
        .simulation-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .canvas-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        #rheologyCanvas {
            width: 100%;
            height: 400px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #fefefe;
        }
        
        #flowCanvas {
            width: 100%;
            height: 400px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            background: #fefefe;
        }
        
        .info-panel {
            background: #2c3e50;
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            grid-column: 1 / -1;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .parameter {
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .highlight {
            color: #e17055;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .condition-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .condition-btn {
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #e17055;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .condition-btn:hover {
            background: #d63031;
            transform: translateY(-2px);
        }
        
        .condition-btn.active {
            background: #00b894;
        }
        
        .chart-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .explanation {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü©∏ Blood Rheology and Non-Newtonian Behavior</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="hematocrit">Hematocrit (%)</label>
                <input type="range" id="hematocrit" min="20" max="60" step="1" value="42">
                <div class="value-display" id="hematocritValue">42% (Normal)</div>
            </div>
            
            <div class="control-group">
                <label for="shearRate">Shear Rate (s‚Åª¬π)</label>
                <input type="range" id="shearRate" min="0.1" max="1000" step="0.1" value="100">
                <div class="value-display" id="shearRateValue">100 s‚Åª¬π</div>
            </div>
            
            <div class="control-group">
                <label for="temperature">Temperature (¬∞C)</label>
                <input type="range" id="temperature" min="32" max="42" step="0.5" value="37">
                <div class="value-display" id="temperatureValue">37¬∞C (Body temp)</div>
            </div>
            
            <div class="control-group">
                <label for="aggregation">RBC Aggregation</label>
                <input type="range" id="aggregation" min="0" max="100" step="5" value="50">
                <div class="value-display" id="aggregationValue">Normal aggregation</div>
            </div>
        </div>
        
        <div class="condition-buttons">
            <button class="condition-btn active" onclick="setCondition('normal', event)">Normal Blood</button>
            <button class="condition-btn" onclick="setCondition('anemia', event)">Anemia</button>
            <button class="condition-btn" onclick="setCondition('polycythemia', event)">Polycythemia</button>
            <button class="condition-btn" onclick="setCondition('sickle', event)">Sickle Cell</button>
            <button class="condition-btn" onclick="setCondition('diabetes', event)">Diabetes</button>
        </div>
        
        <div class="simulation-area">
            <div class="canvas-container">
                <div class="chart-title">Viscosity vs Shear Rate</div>
                <canvas id="rheologyCanvas" width="600" height="400"></canvas>
            </div>
            
            <div class="canvas-container">
                <div class="chart-title">Blood Flow Visualization</div>
                <canvas id="flowCanvas" width="600" height="400"></canvas>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="info-grid">
                <div class="parameter">
                    <strong>Apparent Viscosity:</strong><br>
                    <span class="highlight" id="viscosityValue">4.2 mPa¬∑s</span>
                </div>
                
                <div class="parameter">
                    <strong>Flow Behavior:</strong><br>
                    <span class="highlight" id="flowBehavior">Shear-thinning</span>
                </div>
                
                <div class="parameter">
                    <strong>Cell Deformation:</strong><br>
                    <span class="highlight" id="deformationValue">Moderate</span>
                </div>
                
                <div class="parameter">
                    <strong>Yield Stress:</strong><br>
                    <span class="highlight" id="yieldStress">0.12 Pa</span>
                </div>
                
                <div class="parameter">
                    <strong>Current Condition:</strong><br>
                    <span class="highlight" id="conditionName">Normal Blood</span>
                </div>
                
                <div class="parameter">
                    <strong>Clinical Significance:</strong><br>
                    <span class="highlight" id="clinicalNote">Within normal range</span>
                </div>
            </div>
            
            <div class="explanation">
                <strong>Key Concepts:</strong><br>
                ‚Ä¢ <strong>Shear-thinning:</strong> Blood viscosity decreases with increasing shear rate<br>
                ‚Ä¢ <strong>Hematocrit effect:</strong> Higher RBC concentration increases viscosity exponentially<br>
                ‚Ä¢ <strong>RBC aggregation:</strong> Forms rouleaux at low shear rates, increasing viscosity<br>
                ‚Ä¢ <strong>Cell deformation:</strong> RBCs deform and align at high shear rates, reducing viscosity<br>
                ‚Ä¢ <strong>F√•hraeus-Lindqvist effect:</strong> Apparent viscosity decreases in small vessels
            </div>
        </div>
    </div>

    <script>
        const rheologyCanvas = document.getElementById('rheologyCanvas');
        const flowCanvas = document.getElementById('flowCanvas');
        const rheologyCtx = rheologyCanvas.getContext('2d');
        const flowCtx = flowCanvas.getContext('2d');
        
        // Control elements
        const hematocritSlider = document.getElementById('hematocrit');
        const shearRateSlider = document.getElementById('shearRate');
        const temperatureSlider = document.getElementById('temperature');
        const aggregationSlider = document.getElementById('aggregation');
        
        // Display elements
        const hematocritValue = document.getElementById('hematocritValue');
        const shearRateValue = document.getElementById('shearRateValue');
        const temperatureValue = document.getElementById('temperatureValue');
        const aggregationValue = document.getElementById('aggregationValue');
        const viscosityValue = document.getElementById('viscosityValue');
        const flowBehavior = document.getElementById('flowBehavior');
        const deformationValue = document.getElementById('deformationValue');
        const yieldStress = document.getElementById('yieldStress');
        const conditionName = document.getElementById('conditionName');
        const clinicalNote = document.getElementById('clinicalNote');
        
        let currentCondition = 'normal';
        let animationTime = 0;
        let animationId = null;
        

        
        function calculateViscosity(shearRate, hematocrit, temperature, aggregation) {
            // Carreau-Yasuda model for blood viscosity
            const temp = parseFloat(temperature);
            const hct = parseFloat(hematocrit) / 100;
            const gamma = parseFloat(shearRate);
            const agg = parseFloat(aggregation) / 100;
            
            // Temperature effect
            const tempFactor = Math.exp(0.025 * (37 - temp));
            
            // Hematocrit effect (Quemada model influence)
            const hctFactor = Math.pow(1 - 0.45 * hct, -2.5);
            
            // Base viscosity parameters
            const eta_inf = 0.0035; // Infinite shear viscosity (Pa¬∑s)
            const eta_0_base = 0.025; // Zero shear viscosity base (Pa¬∑s)
            
            // Aggregation effect on zero shear viscosity
            const eta_0 = eta_0_base * (1 + 2 * agg);
            
            // Carreau-Yasuda parameters
            const lambda = 1.0; // Time constant
            const n = 0.6; // Power law index
            const a = 2; // Yasuda parameter
            
            // Carreau-Yasuda equation
            const viscosity = eta_inf + (eta_0 - eta_inf) * 
                Math.pow(1 + Math.pow(lambda * gamma, a), (n - 1) / a);
            
            return viscosity * hctFactor * tempFactor;
        }
        
        function drawRheologyChart() {
            if (!rheologyCtx || !rheologyCanvas) {
                console.error('Rheology canvas not available');
                return;
            }
            rheologyCtx.clearRect(0, 0, rheologyCanvas.width, rheologyCanvas.height);
            
            const hct = parseFloat(hematocritSlider.value);
            const temp = parseFloat(temperatureSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            const currentShearRate = parseFloat(shearRateSlider.value);
            
            // Draw axes
            rheologyCtx.strokeStyle = '#2c3e50';
            rheologyCtx.lineWidth = 2;
            
            // Y-axis (viscosity)
            rheologyCtx.beginPath();
            rheologyCtx.moveTo(60, 50);
            rheologyCtx.lineTo(60, 350);
            rheologyCtx.stroke();
            
            // X-axis (shear rate)
            rheologyCtx.beginPath();
            rheologyCtx.moveTo(60, 350);
            rheologyCtx.lineTo(550, 350);
            rheologyCtx.stroke();
            
            // Draw viscosity curve
            rheologyCtx.strokeStyle = '#e17055';
            rheologyCtx.lineWidth = 3;
            rheologyCtx.beginPath();
            
            const shearRates = [];
            const viscosities = [];
            
            for (let i = 0; i <= 100; i++) {
                const shearRate = 0.1 + (1000 - 0.1) * i / 100;
                const logShearRate = Math.log10(shearRate);
                const viscosity = calculateViscosity(shearRate, hct, temp, agg);
                
                shearRates.push(shearRate);
                viscosities.push(viscosity);
                
                // Convert to canvas coordinates
                const x = 60 + (logShearRate + 1) / 4 * 490; // Log scale from 0.1 to 1000
                const y = 350 - (viscosity / 0.1) * 300; // Scale to max 0.1 Pa¬∑s
                
                if (i === 0) {
                    rheologyCtx.moveTo(x, Math.max(y, 50));
                } else {
                    rheologyCtx.lineTo(x, Math.max(y, 50));
                }
            }
            rheologyCtx.stroke();
            
            // Mark current point
            const currentVisc = calculateViscosity(currentShearRate, hct, temp, agg);
            const currentX = 60 + (Math.log10(currentShearRate) + 1) / 4 * 490;
            const currentY = 350 - (currentVisc / 0.1) * 300;
            
            rheologyCtx.fillStyle = '#d63031';
            rheologyCtx.beginPath();
            rheologyCtx.arc(currentX, Math.max(currentY, 50), 6, 0, 2 * Math.PI);
            rheologyCtx.fill();
            
            // Add labels
            rheologyCtx.fillStyle = '#2c3e50';
            rheologyCtx.font = '14px Arial';
            rheologyCtx.fillText('Viscosity (mPa¬∑s)', 10, 30);
            rheologyCtx.fillText('Shear Rate (s‚Åª¬π)', 250, 380);
            
            // Shear rate scale labels
            rheologyCtx.font = '12px Arial';
            const shearLabels = [0.1, 1, 10, 100, 1000];
            shearLabels.forEach(rate => {
                const x = 60 + (Math.log10(rate) + 1) / 4 * 490;
                rheologyCtx.fillText(rate.toString(), x - 10, 370);
            });
            
            // Viscosity scale labels
            for (let i = 0; i <= 5; i++) {
                const visc = i * 20; // 0, 20, 40, 60, 80, 100 mPa¬∑s
                const y = 350 - (visc / 100) * 300;
                rheologyCtx.fillText(visc.toString(), 30, y + 5);
            }
        }
        
        function drawFlowVisualization() {
            if (!flowCtx || !flowCanvas) {
                console.error('Flow canvas not available');
                return;
            }
            flowCtx.clearRect(0, 0, flowCanvas.width, flowCanvas.height);
            
            const hct = parseFloat(hematocritSlider.value);
            const shearRate = parseFloat(shearRateSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            
            const centerY = flowCanvas.height / 2;
            const vesselRadius = 80;
            
            // Draw vessel walls
            flowCtx.fillStyle = '#34495e';
            flowCtx.fillRect(0, centerY - vesselRadius - 10, flowCanvas.width, 10);
            flowCtx.fillRect(0, centerY + vesselRadius, flowCanvas.width, 10);
            
            // Calculate cell properties
            const cellDeformation = Math.min(shearRate / 100, 5); // Deformation factor
            const cellSize = 4 + (60 - hct) / 10; // Larger cells with lower hematocrit
            const aggregationEffect = Math.max(0, 1 - shearRate / 100) * agg / 100;
            
            // Draw red blood cells
            const numCells = Math.floor(20 + hct * 0.5); // More cells with higher hematocrit
            
            for (let i = 0; i < numCells; i++) {
                const x = 50 + (i * 30 + animationTime * 20) % (flowCanvas.width - 100);
                const y = centerY - vesselRadius + 20 + (i * 15) % (vesselRadius * 2 - 40);
                
                // Cell deformation based on shear rate
                const cellWidth = cellSize * (1 + cellDeformation);
                const cellHeight = cellSize * (1 - cellDeformation * 0.3);
                
                // Cell color based on aggregation
                const redIntensity = 200 + Math.floor(aggregationEffect * 55);
                flowCtx.fillStyle = `rgb(${redIntensity}, 50, 50)`;
                
                // Draw deformed cell
                flowCtx.beginPath();
                flowCtx.ellipse(x, y, cellWidth, cellHeight, 0, 0, 2 * Math.PI);
                flowCtx.fill();
                
                // Add cell membrane
                flowCtx.strokeStyle = '#8B0000';
                flowCtx.lineWidth = 1;
                flowCtx.stroke();
            }
            
            // Draw velocity profile
            flowCtx.strokeStyle = '#3498db';
            flowCtx.lineWidth = 3;
            flowCtx.beginPath();
            
            for (let i = 0; i < flowCanvas.width - 100; i++) {
                const x = 50 + i;
                const distanceFromCenter = Math.abs(x - flowCanvas.width / 2);
                const normalizedDistance = distanceFromCenter / (flowCanvas.width / 2 - 50);
                
                // Parabolic velocity profile
                const velocityFactor = 1 - (normalizedDistance * normalizedDistance);
                const y = centerY - vesselRadius + 20 + (vesselRadius * 2 - 40) * velocityFactor;
                
                if (i === 0) {
                    flowCtx.moveTo(x, y);
                } else {
                    flowCtx.lineTo(x, y);
                }
            }
            flowCtx.stroke();
            
            // Add labels
            flowCtx.fillStyle = '#2c3e50';
            flowCtx.font = '14px Arial';
            flowCtx.fillText('Blood Flow Visualization', 10, 30);
            flowCtx.fillText(`HCT: ${hct}% | Shear: ${shearRate.toFixed(1)} s‚Åª¬π`, 10, flowCanvas.height - 10);
        }
        
        // Condition configurations
        const conditions = {
            normal: {
                name: 'Normal Blood',
                hematocrit: 45,
                temperature: 37,
                aggregation: 50,
                shearRate: 100,
                note: 'Healthy blood parameters'
            },
            anemia: {
                name: 'Anemia',
                hematocrit: 25,
                temperature: 37,
                aggregation: 30,
                shearRate: 50,
                note: 'Low RBC count, reduced viscosity'
            },
            polycythemia: {
                name: 'Polycythemia',
                hematocrit: 60,
                temperature: 37,
                aggregation: 80,
                shearRate: 200,
                note: 'High RBC count, increased viscosity'
            },
            sickle: {
                name: 'Sickle Cell Disease',
                hematocrit: 35,
                temperature: 37,
                aggregation: 90,
                shearRate: 300,
                note: 'Rigid cells, poor flow'
            },
            diabetes: {
                name: 'Diabetes',
                hematocrit: 45,
                temperature: 37,
                aggregation: 75,
                shearRate: 150,
                note: 'Enhanced aggregation, poor circulation'
            }
        };
        
        function setCondition(condition, event) {
            currentCondition = condition;
            const config = conditions[condition];
            
            // Update sliders
            hematocritSlider.value = config.hematocrit;
            shearRateSlider.value = config.shearRate;
            temperatureSlider.value = config.temperature;
            aggregationSlider.value = config.aggregation;
            
            // Update button states
            document.querySelectorAll('.condition-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            // Update displays
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        }
        
        function updateDisplays() {
            if (!hematocritSlider || !shearRateSlider || !temperatureSlider || !aggregationSlider) {
                console.error('Slider elements not found');
                return;
            }
            
            const hct = parseFloat(hematocritSlider.value);
            const shearRate = parseFloat(shearRateSlider.value);
            const temp = parseFloat(temperatureSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            
            // Update slider displays
            hematocritValue.textContent = `${hct}%`;
            shearRateValue.textContent = `${shearRate} s‚Åª¬π`;
            temperatureValue.textContent = `${temp}¬∞C ${temp === 37 ? '(Body temp)' : ''}`;
            
            // Update aggregation description
            if (agg < 30) {
                aggregationValue.textContent = 'Low aggregation';
            } else if (agg < 60) {
                aggregationValue.textContent = 'Normal aggregation';
            } else {
                aggregationValue.textContent = 'High aggregation';
            }
            
            // Calculate and display viscosity
            const viscosity = calculateViscosity(shearRate, hct, temp, agg);
            viscosityValue.textContent = `${(viscosity * 1000).toFixed(1)} mPa¬∑s`;
            
            // Update flow behavior
            if (shearRate < 50) {
                flowBehavior.textContent = 'Yield stress dominant';
            } else if (shearRate < 200) {
                flowBehavior.textContent = 'Shear-thinning';
            } else {
                flowBehavior.textContent = 'Newtonian-like';
            }
            
            // Update deformation
            const deformation = Math.min(shearRate / 100, 5);
            if (deformation < 1) {
                deformationValue.textContent = 'Minimal';
            } else if (deformation < 3) {
                deformationValue.textContent = 'Moderate';
            } else {
                deformationValue.textContent = 'High';
            }
            
            // Calculate yield stress
            const yieldStressValue = 0.1 + (agg / 100) * 0.3;
            yieldStress.textContent = `${yieldStressValue.toFixed(2)} Pa`;
            
            // Update condition info
            conditionName.textContent = conditions[currentCondition].name;
            clinicalNote.textContent = conditions[currentCondition].note;
        }
        
        // Event listeners
        hematocritSlider.addEventListener('input', () => {
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        temperatureSlider.addEventListener('input', () => {
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        aggregationSlider.addEventListener('input', () => {
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        shearRateSlider.addEventListener('input', () => {
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        // Initialize
        console.log('Initializing Blood Rheology simulation...');
        console.log('Canvas elements:', { rheologyCanvas, flowCanvas });
        console.log('Context elements:', { rheologyCtx, flowCtx });
        
        // Check if all elements are loaded
        if (rheologyCanvas && flowCanvas && rheologyCtx && flowCtx) {
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
            console.log('Simulation initialized successfully');
            
            // Start animation loop
            function animate() {
                animationTime += 0.1;
                drawFlowVisualization();
                animationId = requestAnimationFrame(animate);
            }
            animate();
        } else {
            console.error('Canvas elements not found');
        }
