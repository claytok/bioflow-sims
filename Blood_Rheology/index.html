<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../bioflowsim.png">
    <title>Working Blood Rheology</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 30px;
            font-weight: 300;
            letter-spacing: -0.02em;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        input[type="range"] {
            width: 100%;
        }
        .value-display {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        .simulation-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 8px;
        }
        .info h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .info ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .info li {
            margin: 5px 0;
        }
        .scenario-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .scenario-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }
        .scenario-btn:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f8b);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        .scenario-btn.active {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }
        .equations {
            background: #f1f2f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .equation {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #e74c3c;
        }
        .parameters {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .parameter {
            margin: 5px 0;
            font-size: 14px;
        }
        .parameter strong {
            color: #2c3e50;
        }
        .biological-context {
            font-size: 11px;
            color: #e74c3c;
            font-style: italic;
            text-align: center;
            margin-top: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Blood Rheology</h1>
        
        <div class="scenario-buttons">
            <button class="scenario-btn active" onclick="setCondition('normal', event)">Normal Blood</button>
            <button class="scenario-btn" onclick="setCondition('anemia', event)">Anemia</button>
            <button class="scenario-btn" onclick="setCondition('polycythemia', event)">Polycythemia</button>
            <button class="scenario-btn" onclick="setCondition('sickle', event)">Sickle Cell</button>
            <button class="scenario-btn" onclick="setCondition('diabetes', event)">Diabetes</button>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="hematocrit">Hematocrit (%)</label>
                <input type="range" id="hematocrit" min="20" max="60" value="45" step="5">
                <div class="value-display" id="hematocritValue">45%</div>
                <div class="biological-context" id="hematocritContext">Normal Blood</div>
            </div>
            
            <div class="control-group">
                <label for="shearRate">Shear Rate (s⁻¹)</label>
                <input type="range" id="shearRate" min="0.1" max="1000" value="100" step="10">
                <div class="value-display" id="shearRateValue">100 s⁻¹</div>
                <div class="biological-context" id="shearRateContext">Medium Flow</div>
            </div>
            
            <div class="control-group">
                <label for="temperature">Temperature (°C)</label>
                <input type="range" id="temperature" min="20" max="40" value="37" step="1">
                <div class="value-display" id="temperatureValue">37°C</div>
                <div class="biological-context" id="temperatureContext">Body Temperature</div>
            </div>
            
            <div class="control-group">
                <label for="aggregation">RBC Aggregation</label>
                <input type="range" id="aggregation" min="0" max="100" value="50" step="5">
                <div class="value-display" id="aggregationValue">50%</div>
                <div class="biological-context" id="aggregationContext">Normal Aggregation</div>
            </div>
        </div>
        
        <div class="simulation-area">
            <div>
                <h3>Viscosity vs Shear Rate</h3>
                <canvas id="rheologyCanvas" width="400" height="300"></canvas>
            </div>
            <div>
                <h3>Blood Flow Visualization</h3>
                <canvas id="flowCanvas" width="400" height="300"></canvas>
            </div>
        </div>
        
        <div class="parameters">
            <h3>Current Parameters</h3>
            <div class="parameter">
                <strong>Viscosity:</strong> <span id="viscosityDisplay">4.2 mPa·s</span>
            </div>
            <div class="parameter">
                <strong>Flow Behavior Index:</strong> <span id="flowIndexDisplay">0.6</span>
            </div>
            <div class="parameter">
                <strong>Yield Stress:</strong> <span id="yieldStressDisplay">0.05 Pa</span>
            </div>
            <div class="parameter">
                <strong>RBC Deformation:</strong> <span id="deformationDisplay">2.1</span>
            </div>
            <div class="parameter">
                <strong>Aggregation Index:</strong> <span id="aggregationIndexDisplay">0.5</span>
            </div>
        </div>
        
        <div class="equations">
            <h3>Mathematical Models</h3>
            <div class="equation">
                <strong>Carreau-Yasuda Model:</strong><br>
                η(γ̇) = η∞ + (η₀ - η∞)[1 + (λγ̇)ᵃ]⁽ⁿ⁻¹⁾/ᵃ<br>
                <em>Non-Newtonian viscosity as function of shear rate</em>
            </div>
            <div class="equation">
                <strong>Hematocrit Effect:</strong><br>
                η = ηₚ(1 - φ)⁻²·⁵<br>
                <em>Viscosity increases with RBC volume fraction</em>
            </div>
            <div class="equation">
                <strong>Temperature Effect:</strong><br>
                η(T) = η₀ × exp(Eₐ/R × (1/T₀ - 1/T))<br>
                <em>Viscosity decreases with temperature</em>
            </div>
            <div class="equation">
                <strong>Casson Model:</strong><br>
                √τ = √τᵧ + √(ηγ̇)<br>
                <em>Yield stress model for blood flow</em>
            </div>
        </div>
        
        <div class="info">
            <h3>What you're seeing:</h3>
            <ul>
                <li><strong>Left graph:</strong> Viscosity decreases with increasing shear rate (shear-thinning)</li>
                <li><strong>Right visualization:</strong> Red blood cells flowing through a vessel</li>
                <li><strong>Non-Newtonian behavior:</strong> Blood viscosity changes with flow conditions</li>
                <li><strong>Hematocrit effect:</strong> Higher RBC concentration increases viscosity</li>
            </ul>
            <p><strong>Key concept:</strong> Blood is a non-Newtonian fluid - its viscosity depends on shear rate!</p>
        </div>
    </div>

    <script>
        const rheologyCanvas = document.getElementById('rheologyCanvas');
        const flowCanvas = document.getElementById('flowCanvas');
        const rheologyCtx = rheologyCanvas.getContext('2d');
        const flowCtx = flowCanvas.getContext('2d');
        
        const hematocritSlider = document.getElementById('hematocrit');
        const shearRateSlider = document.getElementById('shearRate');
        const temperatureSlider = document.getElementById('temperature');
        const aggregationSlider = document.getElementById('aggregation');
        
        const hematocritValue = document.getElementById('hematocritValue');
        const shearRateValue = document.getElementById('shearRateValue');
        const temperatureValue = document.getElementById('temperatureValue');
        const aggregationValue = document.getElementById('aggregationValue');
        
        const viscosityDisplay = document.getElementById('viscosityDisplay');
        const flowIndexDisplay = document.getElementById('flowIndexDisplay');
        const yieldStressDisplay = document.getElementById('yieldStressDisplay');
        const deformationDisplay = document.getElementById('deformationDisplay');
        const aggregationIndexDisplay = document.getElementById('aggregationIndexDisplay');
        
        const hematocritContext = document.getElementById('hematocritContext');
        const shearRateContext = document.getElementById('shearRateContext');
        const temperatureContext = document.getElementById('temperatureContext');
        const aggregationContext = document.getElementById('aggregationContext');
        
        const conditions = {
            normal: {
                name: 'Normal Blood',
                hematocrit: 45,
                aggregation: 50,
                temperature: 37,
                description: 'Healthy blood with normal RBC count and properties'
            },
            anemia: {
                name: 'Anemia',
                hematocrit: 25,
                aggregation: 30,
                temperature: 37,
                description: 'Low RBC count, reduced viscosity'
            },
            polycythemia: {
                name: 'Polycythemia',
                hematocrit: 60,
                aggregation: 70,
                temperature: 37,
                description: 'High RBC count, increased viscosity'
            },
            sickle: {
                name: 'Sickle Cell',
                hematocrit: 35,
                aggregation: 80,
                temperature: 37,
                description: 'Abnormal RBC shape, increased aggregation'
            },
            diabetes: {
                name: 'Diabetes',
                hematocrit: 45,
                aggregation: 60,
                temperature: 37,
                description: 'Increased RBC aggregation due to glucose'
            }
        };
        
        function setCondition(condition, event = null) {
            const config = conditions[condition];
            
            // Update sliders
            hematocritSlider.value = config.hematocrit;
            aggregationSlider.value = config.aggregation;
            temperatureSlider.value = config.temperature;
            
            // Update displays
            hematocritValue.textContent = `${config.hematocrit}%`;
            aggregationValue.textContent = `${config.aggregation}%`;
            temperatureValue.textContent = `${config.temperature}°C`;
            
            // Update button states
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            if (event) {
                event.target.classList.add('active');
            }
            
            // Update displays (this now includes updateBiologicalContext())
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        }
        
        function calculateViscosity(shearRate, hematocrit, temperature, aggregation) {
            const temp = parseFloat(temperature);
            const hct = parseFloat(hematocrit) / 100;
            const gamma = parseFloat(shearRate);
            const agg = parseFloat(aggregation) / 100;
            
            // Temperature effect
            const tempFactor = Math.exp(0.025 * (37 - temp));
            
            // Hematocrit effect
            const hctFactor = Math.pow(1 - 0.45 * hct, -2.5);
            
            // Base viscosity parameters
            const eta_inf = 0.0035; // Infinite shear viscosity
            const eta_0_base = 0.025; // Zero shear viscosity base
            
            // Aggregation effect on zero shear viscosity
            const eta_0 = eta_0_base * (1 + 2 * agg);
            
            // Carreau-Yasuda parameters
            const lambda = 1.0;
            const n = 0.6;
            const a = 2;
            
            // Carreau-Yasuda equation
            const viscosity = eta_inf + (eta_0 - eta_inf) * 
                Math.pow(1 + Math.pow(lambda * gamma, a), (n - 1) / a);
            
            return viscosity * hctFactor * tempFactor;
        }
        
        function drawRheologyChart() {
            rheologyCtx.clearRect(0, 0, rheologyCanvas.width, rheologyCanvas.height);
            
            const hct = parseFloat(hematocritSlider.value);
            const temp = parseFloat(temperatureSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            const currentShearRate = parseFloat(shearRateSlider.value);
            
            // Draw axes
            rheologyCtx.strokeStyle = '#2c3e50';
            rheologyCtx.lineWidth = 2;
            
            // Y-axis (viscosity)
            rheologyCtx.beginPath();
            rheologyCtx.moveTo(60, 50);
            rheologyCtx.lineTo(60, 250);
            rheologyCtx.stroke();
            
            // X-axis (shear rate)
            rheologyCtx.beginPath();
            rheologyCtx.moveTo(60, 250);
            rheologyCtx.lineTo(350, 250);
            rheologyCtx.stroke();
            
            // Draw viscosity curve
            rheologyCtx.strokeStyle = '#e74c3c';
            rheologyCtx.lineWidth = 3;
            rheologyCtx.beginPath();
            
            for (let i = 0; i <= 100; i++) {
                const shearRate = 0.1 + (1000 - 0.1) * i / 100;
                const logShearRate = Math.log10(shearRate);
                const viscosity = calculateViscosity(shearRate, hct, temp, agg);
                
                // Convert to canvas coordinates
                const x = 60 + (logShearRate + 1) / 4 * 290;
                const y = 250 - (viscosity / 0.1) * 200;
                
                if (i === 0) {
                    rheologyCtx.moveTo(x, Math.max(y, 50));
                } else {
                    rheologyCtx.lineTo(x, Math.max(y, 50));
                }
            }
            rheologyCtx.stroke();
            
            // Mark current point
            const currentVisc = calculateViscosity(currentShearRate, hct, temp, agg);
            const currentX = 60 + (Math.log10(currentShearRate) + 1) / 4 * 290;
            const currentY = 250 - (currentVisc / 0.1) * 200;
            
            rheologyCtx.fillStyle = '#e74c3c';
            rheologyCtx.beginPath();
            rheologyCtx.arc(currentX, Math.max(currentY, 50), 6, 0, 2 * Math.PI);
            rheologyCtx.fill();
            
            // Add labels
            rheologyCtx.fillStyle = '#2c3e50';
            rheologyCtx.font = '12px Arial';
            rheologyCtx.fillText('Viscosity (Pa·s)', 10, 30);
            rheologyCtx.fillText('Shear Rate (s⁻¹)', 150, 270);
        }
        
        function drawFlowVisualization() {
            flowCtx.clearRect(0, 0, flowCanvas.width, flowCanvas.height);
            
            const hct = parseFloat(hematocritSlider.value);
            const shearRate = parseFloat(shearRateSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            
            const centerY = flowCanvas.height / 2;
            const vesselRadius = 60;
            
            // Draw vessel walls
            flowCtx.fillStyle = '#34495e';
            flowCtx.fillRect(0, centerY - vesselRadius - 8, flowCanvas.width, 8);
            flowCtx.fillRect(0, centerY + vesselRadius, flowCanvas.width, 8);
            
            // Calculate cell properties
            const cellDeformation = Math.min(shearRate / 100, 3);
            const cellSize = 3 + (60 - hct) / 10;
            const aggregationEffect = Math.max(0, 1 - shearRate / 100) * agg / 100;
            
            // Draw red blood cells
            const numCells = Math.floor(15 + hct * 0.3);
            
            for (let i = 0; i < numCells; i++) {
                const x = 50 + (i * 25) % (flowCanvas.width - 100);
                const y = centerY - vesselRadius + 15 + (i * 12) % (vesselRadius * 2 - 30);
                
                // Cell deformation based on shear rate
                const cellWidth = cellSize * (1 + cellDeformation);
                const cellHeight = cellSize * (1 - cellDeformation * 0.3);
                
                // Cell color based on aggregation
                const redIntensity = 200 + Math.floor(aggregationEffect * 55);
                flowCtx.fillStyle = `rgb(${redIntensity}, 50, 50)`;
                
                // Draw deformed cell
                flowCtx.beginPath();
                flowCtx.ellipse(x, y, cellWidth, cellHeight, 0, 0, 2 * Math.PI);
                flowCtx.fill();
                
                // Add cell membrane
                flowCtx.strokeStyle = '#8B0000';
                flowCtx.lineWidth = 1;
                flowCtx.stroke();
            }
            
            // Add labels
            flowCtx.fillStyle = '#2c3e50';
            flowCtx.font = '12px Arial';
            flowCtx.fillText('Blood Flow', 10, 20);
            flowCtx.fillText(`HCT: ${hct}% | Shear: ${shearRate.toFixed(1)} s⁻¹`, 10, flowCanvas.height - 10);
        }
        
        function updateDisplays() {
            const hct = parseFloat(hematocritSlider.value);
            const shearRate = parseFloat(shearRateSlider.value);
            const temp = parseFloat(temperatureSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            
            // Calculate current viscosity
            const viscosity = calculateViscosity(shearRate, hct, temp, agg);
            
            // Calculate flow behavior index (n) - varies with shear rate
            const n = 0.4 + 0.4 * Math.exp(-shearRate / 50); // More non-Newtonian at low shear
            
            // Calculate yield stress - more realistic values
            const yieldStress = 0.02 * (1 + agg / 50); // 0.02-0.06 Pa range
            
            // Calculate RBC deformation - more realistic
            const deformation = Math.min(shearRate / 200, 3);
            
            // Update displays
            viscosityDisplay.textContent = `${(viscosity * 1000).toFixed(1)} mPa·s`;
            flowIndexDisplay.textContent = n.toFixed(2);
            yieldStressDisplay.textContent = `${yieldStress.toFixed(3)} Pa`;
            deformationDisplay.textContent = deformation.toFixed(1);
            aggregationIndexDisplay.textContent = agg.toFixed(0);
            
            // Update biological context
            updateBiologicalContext();
        }
        
        // Event listeners
        hematocritSlider.addEventListener('input', () => {
            hematocritValue.textContent = `${hematocritSlider.value}%`;
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        shearRateSlider.addEventListener('input', () => {
            shearRateValue.textContent = `${shearRateSlider.value} s⁻¹`;
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        temperatureSlider.addEventListener('input', () => {
            temperatureValue.textContent = `${temperatureSlider.value}°C`;
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        aggregationSlider.addEventListener('input', () => {
            aggregationValue.textContent = `${aggregationSlider.value}%`;
            updateDisplays();
            drawRheologyChart();
            drawFlowVisualization();
        });
        
        function updateBiologicalContext() {
            const hct = parseFloat(hematocritSlider.value);
            const shearRate = parseFloat(shearRateSlider.value);
            const temp = parseFloat(temperatureSlider.value);
            const agg = parseFloat(aggregationSlider.value);
            
            // Hematocrit context
            if (hct < 30) hematocritContext.textContent = 'Anemia';
            else if (hct < 40) hematocritContext.textContent = 'Low Normal';
            else if (hct < 50) hematocritContext.textContent = 'Normal Blood';
            else if (hct < 55) hematocritContext.textContent = 'High Normal';
            else hematocritContext.textContent = 'Polycythemia';
            
            // Shear rate context
            if (shearRate < 1) shearRateContext.textContent = 'Very Low Flow';
            else if (shearRate < 10) shearRateContext.textContent = 'Low Flow';
            else if (shearRate < 100) shearRateContext.textContent = 'Medium Flow';
            else if (shearRate < 500) shearRateContext.textContent = 'High Flow';
            else shearRateContext.textContent = 'Very High Flow';
            
            // Temperature context
            if (temp < 30) temperatureContext.textContent = 'Hypothermia';
            else if (temp < 36) temperatureContext.textContent = 'Low Normal';
            else if (temp < 38) temperatureContext.textContent = 'Body Temperature';
            else temperatureContext.textContent = 'Fever';
            
            // Aggregation context
            if (agg < 20) aggregationContext.textContent = 'Low Aggregation';
            else if (agg < 40) aggregationContext.textContent = 'Normal Aggregation';
            else if (agg < 60) aggregationContext.textContent = 'High Aggregation';
            else if (agg < 80) aggregationContext.textContent = 'Very High Aggregation';
            else aggregationContext.textContent = 'Pathological Aggregation';
        }
        
        // Initialize
        updateDisplays();
        drawRheologyChart();
        drawFlowVisualization();
    </script>
</body>
</html> 